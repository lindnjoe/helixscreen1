name: LVGL Release Tracker

# Automatically check LVGL releases weekly and create issues when v9.5+ is released
# This helps us track when to upgrade and evaluate new features (slots, style binds, formulas)

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:      # Manual trigger for testing

jobs:
  check-lvgl:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check LVGL releases and create issue if v9.5+ found
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch recent LVGL releases
            const { data: releases } = await github.rest.repos.listReleases({
              owner: 'lvgl',
              repo: 'lvgl',
              per_page: 10
            });

            if (releases.length === 0) {
              console.log('No releases found');
              return;
            }

            const latest = releases[0];
            console.log(`Latest LVGL release: ${latest.tag_name} (${latest.published_at})`);

            // Check if this is v9.5.x or higher (not RC/beta)
            const versionMatch = latest.tag_name.match(/^v(\d+)\.(\d+)\.(\d+)$/);
            if (!versionMatch) {
              console.log(`Tag ${latest.tag_name} doesn't match release pattern, skipping`);
              return;
            }

            const [, major, minor, patch] = versionMatch.map(Number);
            const isV95OrHigher = major >= 9 && minor >= 5;

            console.log(`Parsed version: ${major}.${minor}.${patch}`);
            console.log(`Is v9.5+: ${isV95OrHigher}`);

            if (!isV95OrHigher) {
              console.log('Not v9.5+, no action needed');
              return;
            }

            // Check if we already have an issue for this exact version
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'lvgl',
              per_page: 100
            });

            const issueTitle = `ðŸŽ‰ LVGL ${latest.tag_name} Released - Review Upgrade`;
            const alreadyExists = existingIssues.data.some(issue =>
              issue.title.includes(latest.tag_name)
            );

            if (alreadyExists) {
              console.log(`Issue for ${latest.tag_name} already exists, skipping`);
              return;
            }

            // Create the issue
            const body = `## LVGL ${latest.tag_name} Released

            **Release Date**: ${new Date(latest.published_at).toLocaleDateString()}
            **Release Notes**: ${latest.html_url}

            ## Key Features to Evaluate

            ### Already Merged (Ready to Use)
            - [ ] **XML Slots** ([PR #9193](https://github.com/lvgl/lvgl/pull/9193)) - Component composition with named anchor points
            - [ ] **Local Style Binds with States** ([PR #9184](https://github.com/lvgl/lvgl/pull/9184)) - Dynamic styling for widget states/parts

            ### Potentially Available
            - [ ] **Formula Evaluator** - Check if merged; enables XML calculations like \`width="=(#screen_width - #margin * 2)"\`
            - [ ] **NanoVG Backend** - Vector rendering, could help with 2D performance

            ## Action Items

            1. [ ] Review [changelog](${latest.html_url}) for breaking changes
            2. [ ] Test build with new version in feature branch
            3. [ ] Evaluate slot feature with \`docs/SLOT_COMPONENT_DESIGNS.md\` patterns
            4. [ ] Test formula evaluator capabilities (if merged)
            5. [ ] Plan upgrade timeline (recommend waiting for ${latest.tag_name.replace(/\.0$/, '.1')} patch)

            ## Upgrade Checklist

            - [ ] Update \`lib/lvgl\` submodule to ${latest.tag_name}
            - [ ] Run full test suite
            - [ ] Test on target hardware (AD5M, Pi)
            - [ ] Update \`docs/SLOT_COMPONENT_DESIGNS.md\` with final API if changed

            ## Reference

            - [LVGL 9.5 Planning Issue](https://github.com/lvgl/lvgl/issues/9254)
            - [HelixScreen Slot Designs](docs/SLOT_COMPONENT_DESIGNS.md)
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: body.split('\n').map(line => line.trim()).join('\n'),
              labels: ['lvgl', 'upgrade']
            });

            console.log(`Created issue: ${issueTitle}`);
